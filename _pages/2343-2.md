---
ID: 2343
post_title: Installing DCOS on-premises (1.5)
author: Joel Hamill
post_date: 2016-01-12 16:20:18
post_excerpt: ""
layout: page
permalink: >
  http://local.mesodocs.com/getting-started/installing/installing-enterprise-edition/2343-2/
published: true
page_options_topic_page:
  - 'a:1:{i:0;s:0:"";}'
page_options_require_authentication: false
page_options_show_link_unauthenticated: false
hide_from_navigation: false
hide_from_related: true
---
This topic provides instructions for installing DCOS in your environment by using a customized Bash install script.

The DCOS installation creates these folders:

*   `/opt/mesosphere`
    :   Contains all the DCOS binaries, libraries, cluster configuration. Do not modify.

*   `/etc/systemd/system/dcos.target.wants`
    :   Contains the systemd services which start the things that make up systemd. They must live outside of `/opt/mesosphere` because of systemd constraints.

*   Various units prefixed with `dcos` in `/etc/systemd/system`
    :   Copies of the units in `/etc/systemd/system/dcos.target.wants`. They must be at the top folder as well as inside `dcos.target.wants`.

The DCOS Enterprise Edition is installed in your environment by using a dynamically generated setup file. This file is generated by using specific parameters that are set during installation. This installation file contains a Bash install script and a Docker container that is loaded with everything you need to create a customized DCOS build.

# Prerequisites

Contact your sales representative or <sales@mesosphere.io> to obtain the DCOS setup file.

### <a name="prerequisites"></a>Workstation prerequisites

Before installing DCOS you must prepare your workstation environment.

*   **Docker** Docker version 1.6 or greater must be installed on your workstation. If you are using RHEL7, Docker must be installed by using a subscription channel. For more information, see <a href="https://access.redhat.com/articles/881893" target="_blank">Docker Formatted Container Images on Red Hat Systems</a>.
*   **nginx Docker image** The Docker nginx image must be on your workstation. You can use this command to install the nginx container:
    
        $ docker pull nginx
        
    
    For more information, see <a href="https://hub.docker.com/_/nginx/" target="_blank">DockerHub nginx</a> documentation.

*   **Zookeeper for shared storage** Shared storage is required by DCOS during installation and runtime for bootstrapping and managing the internal DCOS Zookeeper cluster. The Zookeeper for shared storage instance is used only for bootstrapping the DCOS Exhibitor instance.
    
    Exhibitor automatically configures your Zookeeper installation on the master nodes during your DCOS installation. This Zookeeper instance should be separate from your cluster. Consider using a separate directory path for the DCOS cluster so that it does not interfere with other services that use the Zookeeper instance.
    
    Temporary outages while the cluster is running are acceptable, but shared storage should generally be up and running to support replacing failed masters.
    
    **Tip:** To start a Zookeeper instance using Docker, run this command:
    
        $ docker run -d -p 2181:2181 -p 2888:2888 -p 3888:3888 --name=dcos_int_zk jplock/zookeeper
        
    
    <!-- Amazon S3 bucket
: This must be a preexisting S3 bucket. -->
    
    <!-- Shared file system
: An Network File System (NFS) mount that Exhibitor can write to. -->

### Cluster prerequisites

Before installing DCOS you must prepare your cluster environment.

*   **Data compression** You must have the <a href="http://www.info-zip.org/UnZip.html" target="_blank">UnZip</a>, <a href="https://www.gnu.org/software/tar/" target="_blank">GNU tar</a>, and <a href="http://tukaani.org/xz/" target="_blank">XZ Utils</a> data compression utilities installed on your cluster nodes.
    
    To install these utilities on CentOS7 and RHEL7:
    
        $ yum install -y tar xz unzip curl
        

*   **Docker** Docker version 1.6 or greater must be installed on your cluster nodes. You must run Docker commands as the root user (`sudo`). For more information, see [Docker installation][1].
    
    *   You can install Docker by using this command:
        
            $ curl -sSL https://get.docker.com | sh
            
        
        If you are using CentOS7 and behind a firewall, you can install Docker by using this command:
        
            $ yum install -y docker
            
    
    *   You must enable the Docker service:
        
            $ sudo systemctl enable docker
            
    
    *   If you are using Docker as a non-root user, you must add your user to the "docker" group:
        
            $ sudo usermod -aG docker <user>
            
    
    *   You can test that your Docker build is properly installed with these commands:
        
            $ sudo service docker start $ sudo docker ps
            
    
    *   If you are using RHEL7, Docker must be installed by using a subscription channel. For more information, see <a href="https://access.redhat.com/articles/881893" target="_blank">Docker Formatted Container Images on Red Hat Systems</a>.

*   **Linux distribution** A supported Linux distribution must be installed on your cluster:
    
    *   Enterprise Linux 7 (RedHat, CentOS)
    *   CoreOS

*   **Nodes**
    
    *   A cluster of 8 or more machines with a supported Linux distribution. The recommended capacity for each node is 16 GB RAM/2 Cores and 16 GB disk space. The minimum size of a node is a machine with 10 GB of disk space and 1 GB of RAM.
    *   All of the nodes in your cluster must be able to send and receive traffic to each other.
    *   IPv6 must be disabled for all nodes. For more information see <a href="https://wiki.centos.org/FAQ/CentOS7#head-8984faf811faccca74c7bcdd74de7467f2fcd8ee" target="_blank">How do I disable IPv6</a>.

*   **Port configuration**
    
    *   ICMP must be enabled between the master and the agent nodes.
    *   TCP and UDP enabled port 53 for DNS.
    *   These ports must be open for communication to the master nodes. 
        *   TCP port 5050 for Mesos masters
        *   TCP port 8080 for Marathon
        *   TCP port 2181 for Zookeeper, see the <a href="http://zookeeper.apache.org/doc/r3.1.2/zookeeperAdmin.html#sc_zkCommands" target="_blank">ZK Admin Guide</a>
        *   TCP ports 8181, 2888, and 3888 for Exhibitor, see the <a href="https://github.com/Netflix/exhibitor/wiki/REST-Introduction" target="_blank">Exhibitor REST Documentation</a>
    *   These ports must be open for communication to the agent nodes from the master nodes: 
        *   TCP port 5051 for Mesos agent communication.

*   **System updates** Make sure you've updated your system to the latest version.
    
    *   On CentOS7 and RHEL7, you can update your system by using this command:
        
            $ yum upgrade -y
            

# <a name="config-cluster"></a>Step 1: Prepare your cluster

In this step you prepare your cluster for DCOS installation.

1.  On each of your master and agent nodes, disable SELinux or set it to permissive mode. This enables DCOS services and Docker to function properly.
    
        $ sudo sed -i s/SELINUX=enforcing/SELINUX=permissive/g /etc/selinux/config
        
    
    **Tip:** You can verify the status of SELinux with the `sestatus`command.

2.  Add `nogroup` to each of your Mesos masters and agents.
    
        $ sudo groupadd nogroup
        

3.  Reboot your cluster for the changes to take affect:
    
        $ sudo reboot
        

# <a name="create-script"></a>Step 2: Create a script for IP address discovery

In this step you create an IP detect script to broadcast the IP address of each node across the cluster. Each node in a DCOS cluster has a unique IP address that is used to communicate between nodes in the cluster. The IP detect script prints the unique IPv4 address of a node to STDOUT each time DCOS is started on the node.

**Important:** The IP address of a node must not change after DCOS is installed on the node. For example, the IP address must not change when a node is rebooted or if the DHCP lease is renewed. If the IP address of a node does change, the node must be [wiped and reinstalled][2].

1.  Create a directory named `dcos/genconf` on your workstation.

2.  Create an IP detection script for your environment and save as `genconf/ip-detect`.

### Examples

*   #### Query an authority
    
    Here is another example using the AWS Metadata service to get the IP address:
    
        #!/bin/sh
        # Example ip-detect script using an external authority
        # Uses the AWS Metadata Service to get the node's internal
        # ipv4 address
        curl -fsSL http://169.254.169.254/latest/meta-data/local-ipv4
        

*   #### Use the IP address of an existing interface
    
    This method discovers the IP address of a particular interface of the node.
    
    If you have multiple generations of hardware with different internals, the interface names can change between hosts. The IP detection script must account for the interface name changes. The example script could also be confused if you attach multiple IP addresses to a single interface, or do complex Linux networking, etc.
    
        #!/usr/bin/env bash
        set -o nounset -o errexit
        export PATH=/usr/sbin:/usr/bin:$PATH
        echo $(ip addr show eth0 | grep -Eo '[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}' | head -1)
        

*   #### Use the network route to the Mesos master
    
    This method uses the route to a Mesos master to find the source IP address to then communicate with that node.
    
    In this example, we assume that the Mesos master has an IP address of `172.28.128.3`. You can use any language for this script. Your Shebang line must be pointed at the correct environment for the language used and the output must be the correct IP address.
    
        #!/usr/bin/env bash
        set -o nounset -o errexit
        
        MASTER_IP=172.28.128.3
        
        echo $(/usr/sbin/ip route show to match 172.28.128.3 | grep -Eo '[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}' | tail -1)
        

# <a name="config-json"></a>Step 3: Configure your cluster

In this step you create a YAML configuration file that is customized for your environment. DCOS uses this configuration file during installation to generate your cluster installation files. In these instructions we assume that you are using ZooKeeper for shared storage.

1.  Customize the config.yaml file for your environment.
    
        cluster_config:
          bootstrap_url: 'file:///opt/dcos_install_tmp'
          cluster_name: '<cluster-name>'
          exhibitor_storage_backend: zookeeper
          exhibitor_zk_hosts: <host1>:<port1>
          exhibitor_zk_path: /dcos
          master_discovery: static 
          master_list:
          - <master-ip-1>
          - <master-ip-2>
          - <master-ip-3>
          resolvers:
          - <dns-resolver-1>
          - <dns-resolver-2>
        
        ssh_config:
          ssh_key_path: /genconf/ssh-key
          ssh_port: '<port-number>'
          ssh_user: <username>
          target_hosts:
          - <target-host-1>
          - <target-host-2>
          - <target-host-3>
          - <target-host-4>
          - <target-host-5>
          process_timeout: 120
          extra_ssh_options: -tt
          log_directory: /genconf/logs
        

2.  Specify these parameters for your environment.
    
    *   bootstrap_url
        :   Specify the URI path to the customized DCOS build files on your local machine. By default this is set to `file:///opt/dcos_install_tmp` in the `config.yaml` template file, which is the location where the DCOS installer puts your install tarball.
    
    *   <a name="cluster-name"></a>cluster_name
        :   Specify the name of your cluster.
    
    *   exhibitor_storage_backend
        :   This parameter specifies the type of storage backend for Exhibitor. By default this is set to `zookeeper` in the `config.yaml` template file. During DCOS installation, a storage system is required for configuring and orchestrating Zookeeper with Exhibitor on the master nodes. Exhibitor automatically configures your Zookeeper installation on the master nodes during your DCOS installation.
    
    *   exhibitor_zk_hosts
        :   Specify a comma-separated list of one or more Zookeeper node IP addresses to use for configuring the internal Exhibitor instances. Exhibitor uses this Zookeeper cluster to orchestrate it's configuration.
    
    *   master_discovery
        :   This parameter specifies the Mesos master discovery method. By default this is set to `static` in the `config.yaml` template file. The `static` method uses the Mesos agents to discover the masters by giving each agent a static list of master IPs. The masters must not change IP addresses, and if a master is replaced, the new master must take the old master's IP address
    
    *   master_list
        
        :   Specify a list of your static master IP addresses as a YAML nested series (`-`). For example:
            
            master_list:
            
            *   172\.17.10.101
            *   172\.17.10.102
            *   172\.17.10.103
    
    *   <a name="resolvers"></a>resolvers
        :   Specify a JSON-formatted list of DNS servers for your DCOS host nodes. You must include the escape characters (``) as shown in the template. Set this parameter to the most authoritative nameservers that you have. If you want to resolve internal hostnames, set it to a nameserver that can resolve them.
        
        *Caution:* If you set the `resolvers` parameter incorrectly, you will permanently damage your configuration and have to reinstall DCOS.
    
    *   ssh_key_path
        :   This parameters specifies the path to your SSH key, for example `/genconf/ssh_key`. The SSH information is required for DCOS installation across your cluster nodes.
    
    *   ssh_port
        :   This parameter specifies the port to SSH to, for example `22`.
    
    *   ssh_user
        :   This parameter specifies the SSH username, for example `vagrant`.
    
    *   target_hosts
        :   This parameter specifies your agent host names.
    
    *   process_timeout
        :   This parameter specifies the allowable amount of time, in seconds, for an action to begin after the process forks. This parameter is not the complete process time. The default value is 120 seconds.
    
    *   log_directory
        :   This parameter specifies the path to `genconf/logs`.
    
    *   extra_ssh_options
        :   This parameter is used to specify `-tt` in the SSH commands that are sent to the target hosts to ensure that you have a TTY available to execute `sudo` on the remote machines. By default this is required for CentOS installations.

3.  Save as `genconf/config.yaml`.

4.  Move your SSH key to the `genconf/ssh-key` location:
    
        $ cp <path-to-key> genconf/ssh-key 
        $ chmod 600 <private-key>.pem
        

For more examples and advanced options, see the [configuration file options][3].

# <a name="install-bash"></a>Step 4: Configure and install DCOS

In this step you create a custom DCOS build file on your workstation and then install DCOS onto your cluster.

**Tip:** If something goes wrong and you need to rerun your setup, use these cluster [cleanup instructions][4].

<!-- Early access URL: https://downloads.mesosphere.com/dcos/EarlyAccess/dcos_generate_config.sh -->

<!-- Stable URL: https://downloads.mesosphere.com/dcos/stable/dcos_generate_config.sh -->

1.  Download and save the DCOS setup file, `dcos_generate_config.sh`, to the `dcos` directory on your workstation. This file is used to create your customized DCOS build file.
    
    **Important:** Contact your sales representative or <sales@mesosphere.io> to obtain the DCOS setup file.

2.  From the `dcos` directory, run the DCOS installer shell script on your bootstrapping master nodes to generate a customized DCOS build. The setup script extracts a Docker container that uses the generic DCOS install files to create customized DCOS build files for your cluster. The build files are output to `./genconf/serve/`.
    
    1.  Generate the customized DCOS configuration file and packages.
        
            $ sudo bash dcos_generate_config.sh --genconf
            Extracking docker container from this script
            dcos-genconf.4543c7745c7e-2af26a89fa52-cb932597d7b992.tar
            Loading container into Docker daemon
            ...
            
        
        **Tips:**
        
        *   You must have created [genconf/config.yaml][5] and [genconf/ip-detect][6].
        *   For a detailed view, you can run in debug mode: `$ sudo bash dcos_generate_config.sh --preflight -l debug`
        1.  Run a preflight script to validate that your cluster is installable.
            
                $ sudo bash dcos_generate_config.sh --preflight
                Running mesosphere/dcos-genconf docker BUILD_DIR set to /home/someuser/genconf
                ...
                Running preflight checks
                
        
        2.  Install DCOS on your cluster.
            
                $ sudo bash dcos_generate_config.sh --deploy
                Running mesosphere/dcos-genconf docker with BUILD_DIR set to /home/someuser/genconf
                ...
                Starting DCOS install process
                Running preflight checks
                Creating directories under /etc/mesosphere
                Creating role file for master
                Configuring DCOS
                Setting and starting DCOS
                
                Cleaning up temp directory /opt/dcos_install_tmp
                
        
        3.  Run the DCOS diagnostic script to verify that services are up and running.
            
                $ sudo bash dcos_generate_config.sh --postflight
                

3.  Monitor Exhibitor and wait for it to converge at http://`<master-ip>`:8181/exhibitor/v1/ui/index.html.
    
    **Tip:** This process can take about 10 minutes. During this time you will see the Master nodes become visible on the Exhibitor consoles and come online, eventually showing a green light.
    
    <a href="https://dev-mesosphere-documentation.pantheon.io/wp-content/uploads/2015/12/chef-zk-status.png" rel="attachment wp-att-2112"><img src="https://dev-mesosphere-documentation.pantheon.io/wp-content/uploads/2015/12/chef-zk-status.png" alt="chef-zk-status" width="551" height="467" class="alignnone size-full wp-image-2112" /></a>
    
    When the status icons are green, you can access the DCOS web interface.

4.  Launch the DCOS web interface at: http://`<load-balanced-ip>`/:
    
    <a href="https://dev-mesosphere-documentation.pantheon.io/wp-content/uploads/2015/12/dashboardsmall.png" rel="attachment wp-att-1120"><img src="https://dev-mesosphere-documentation.pantheon.io/wp-content/uploads/2015/12/dashboardsmall.png" alt="dashboardsmall" width="1338" height="828" class="alignnone size-full wp-image-1120" /></a>

 [1]: http://docs.docker.com/engine/installation/
 [2]: /admin/cleanup/
 [3]: /configuration-parameters-1-5/
 [4]: ../getting-started/installing/installing-enterprise-edition/dcos-cleanup-script/
 [5]: #config
 [6]: #create-script